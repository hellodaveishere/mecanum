<!DOCTYPE html>
<html lang="it">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Joystick ROS2</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="css/bootstrap.min.css" />
  <script src="js/bootstrap.bundle.min.js"></script>

  <!-- ROS + Joystick -->
  <script src="js/roslib.min.js"></script>
  <script src="js/nipplejs.min.js"></script>

  <style>
    canvas {
      border: 1px solid #ccc;
      margin-top: 15px;
    }

    .nipple.active {
      box-shadow: 0 0 10px 5px rgba(0, 255, 0, 0.5);
      /* glow verde */
      transition: box-shadow 0.2s ease;
    }

    .joystick-zone {
      width: 200px;
      height: 200px;
      background-color: #e0e0e0;
      border-radius: 50%;
      box-shadow: 0 0 10px rgba(0, 0, 0, 0.2);
      margin-top: 10px;
      position: relative;
    }

    #ros-console {
      background: #f8f9fa;
      border: 1px solid #ccc;
      padding: 10px;
      height: 200px;
      overflow-y: auto;
      white-space: pre-wrap;
    }

    #menuOffcanvas {
      width: 250px;
      /* Imposta la larghezza desiderata */
      max-width: 80vw;
      /* Opzionale: limita la larghezza su schermi piccoli */
    }
  </style>
</head>

<body class="bg-light text-center">
  <div class="container py-4">
    <!-- Navbar -->
    <nav class="navbar navbar-light bg-white border rounded mb-4">
      <div class="container-fluid">
        <div class="row w-100 align-items-center">
          <div class="col-2 text-start">
            <button class="btn btn-outline-secondary" type="button" data-bs-toggle="offcanvas"
              data-bs-target="#menuOffcanvas">
              ‚ò∞
            </button>
          </div>
          <div class="col-8 text-center">
            <span class="navbar-brand mb-0 h1">Controllo Robot Mecanum</span>
          </div>
        </div>
      </div>
    </nav>

    <!-- Offcanvas menu -->
    <div class="offcanvas offcanvas-start" tabindex="-1" id="menuOffcanvas">
      <div class="offcanvas-header">
        <h5 class="offcanvas-title">Menu</h5>
        <button type="button" class="btn-close" data-bs-dismiss="offcanvas"></button>
      </div>
      <div class="offcanvas-body text-start">
        <ul class="list-group">
          <li class="list-group-item">
            <button class="btn btn-link" data-bs-toggle="modal" data-bs-target="#configModal">‚öôÔ∏è Configurazione</button>
          </li>
          <li class="list-group-item">
            <a id="calibrationLink" class="btn btn-link" href="calibration_interface.html" target="_blank"
              rel="noopener noreferrer">
              üõ†Ô∏è Calibrazione
            </a>
          </li>

          <li class="list-group-item">
            <button class="btn btn-link" onclick="alert('Made by Dave!')">‚ÑπÔ∏è About</button>
          </li>
        </ul>
      </div>
    </div>

    <!-- Stato ROS -->
    <div class="alert alert-secondary d-inline-block py-2 px-3 mb-3">
      Stato ROS2: <span id="ros-status" class="text-danger fw-bold">Non connesso</span>
      <label>
        <input type="checkbox" id="joystickControlToggle" checked />
        Attiva controllo joystick
      </label>
    </div>




    <!-- Velocit√† -->
    <div class="mb-3">
      <span class="me-3">Velocit√† lineare: <span id="linear-speed">0.00</span> m/s</span>
      <span>Velocit√† angolare: <span id="angular-speed">0.00</span> rad/s</span>
    </div>

    <!-- Stato batteria -->
    <div id="battery-text">Batteria: --%</div>

    <!-- Canvas video -->
    <canvas id="image-canvas" width="640" height="480" class="img-fluid border rounded mb-4"></canvas>

    <!-- Joystick layout -->
    <div class="d-flex flex-wrap justify-content-center gap-4 mt-4">
      <div class="text-center">
        <h4>Controllo Telecamera</h4>
        <div id="camera-joystick-zone" class="joystick-zone"></div>
      </div>
      <div class="text-center">
        <h4>Controllo Robot</h4>
        <div id="joystick-zone" class="joystick-zone"></div>
      </div>
    </div>

    <!-- Console ROS -->
    <div id="console-section" class="mt-4 d-none text-start">
      <h5 class="text-muted">Console ROS</h5>
      <pre id="ros-console"></pre>
      <div class="input-group mt-2">
        <input type="text" id="publish-message" class="form-control" placeholder="Messaggio da inviare..." />
        <button class="btn btn-primary" id="send-message">Invia</button>
      </div>
    </div>
  </div>

  <!-- Modal configurazione -->
  <div class="modal fade" id="configModal" tabindex="-1">
    <div class="modal-dialog">
      <div class="modal-content text-start">
        <div class="modal-header">
          <h5 class="modal-title">Configurazione</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
        </div>
        <div class="modal-body">
          <!-- IP ROS -->
          <label class="form-label">Indirizzo ROS:</label>
          <select id="ros-ip" class="form-select mb-2">
            <option value="ws://localhost:9091">localhost</option>
            <option value="ws://192.168.188.10:9091">192.168.188.10</option>
            <option value="custom">Altro...</option>
          </select>
          <input type="text" id="custom-ip" class="form-control mb-3 d-none" placeholder="ws://IP:PORT" />

          <!-- Velocit√† -->
          <!-- max 0.25 m/s = max 10 rad/s * 2.5 cm raggio ruota -->
          <label class="form-label d-flex justify-content-between"> 
            <span>Velocit√† massima (m/s):</span> <strong id="max-speed-value">0.25</strong> 
          </label> 
          <input type="range" class="form-range mb-3" id="max-speed" min="0.01" max="0.25" step="0.01" value="0.25" />
          <!-- Console -->
          <hr />
          <div class="form-check mb-2">
            <input class="form-check-input" type="checkbox" id="enable-console" />
            <label class="form-check-label" for="enable-console">Abilita console ROS</label>
          </div>

          <label class="form-label">Topic da sottoscrivere:</label>
          <input type="text" class="form-control mb-2" id="console-topic" value="/rosout" />

          <label class="form-label">Tipo di messaggio:</label>
          <select class="form-select mb-3" id="message-type">
            <option value="std_msgs/msg/String">rcl_interfaces/msg/Log</option>
            <option value="std_msgs/msg/String">std_msgs/msg/String</option>
            <option value="std_msgs/Float64">std_msgs/Float64</option>
            <option value="geometry_msgs/Twist">geometry_msgs/Twist</option>
          </select>

          <label class="form-label">Topic su cui pubblicare:</label>
          <input type="text" class="form-control" id="publish-topic" value="/chatter" />
        </div>
        <div class="modal-footer">
          <button id="apply-config" class="btn btn-primary" data-bs-dismiss="modal">Applica</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Script principale -->
  <script>
    let ros;
    let rosUrl = localStorage.getItem('rosUrl') || 'ws://localhost:9091';
    let maxSpeed = parseFloat(localStorage.getItem('maxSpeed')) || 1.0;
    let consoleEnabled = localStorage.getItem('consoleEnabled') === 'true';
    let consoleTopicName = localStorage.getItem('consoleTopicName') || '/rosout';
    let consoleMessageType = localStorage.getItem('consoleMessageType') || 'rcl_interfaces/msg/Log';
    let publishTopicName = localStorage.getItem('publishTopicName') || '/chatter';
    let consoleSubscriber = null;
    let publisher = null;

    const rosStatus = document.getElementById('ros-status');
    const linearDisplay = document.getElementById('linear-speed');
    const angularDisplay = document.getElementById('angular-speed');
    const maxSpeedSlider = document.getElementById('max-speed');
    const maxSpeedValue = document.getElementById('max-speed-value');
    const rosIpSelect = document.getElementById('ros-ip');
    const customIpInput = document.getElementById('custom-ip');
    const applyConfigBtn = document.getElementById('apply-config');
    const consoleSection = document.getElementById('console-section');
    const consoleOutput = document.getElementById('ros-console');
    const sendMessageBtn = document.getElementById('send-message');

    window.addEventListener('DOMContentLoaded', () => {
      // Ripristina configurazione salvata
      rosIpSelect.value = ['ws://localhost:9091', 'ws://192.168.188.10:9091'].includes(rosUrl) ? rosUrl : 'custom';
      if (rosIpSelect.value === 'custom') {
        customIpInput.classList.remove('d-none');
        customIpInput.value = rosUrl;
      }

      maxSpeedSlider.value = maxSpeed.toFixed(2);
      maxSpeedValue.textContent = maxSpeed.toFixed(2);
      document.getElementById('enable-console').checked = consoleEnabled;
      document.getElementById('console-topic').value = consoleTopicName;
      document.getElementById('message-type').value = consoleMessageType;
      document.getElementById('publish-topic').value = publishTopicName;

      connectToRos();
    });

    maxSpeedSlider.addEventListener('input', () => {
      maxSpeedValue.textContent = parseFloat(maxSpeedSlider.value).toFixed(2);
    });

    rosIpSelect.addEventListener('change', () => {
      customIpInput.classList.toggle('d-none', rosIpSelect.value !== 'custom');
    });

    applyConfigBtn.addEventListener('click', () => {
      const selectedIp = rosIpSelect.value === 'custom' ? customIpInput.value : rosIpSelect.value;
      rosUrl = selectedIp || 'ws://localhost:9091';
      localStorage.setItem('rosUrl', rosUrl);

      maxSpeed = parseFloat(maxSpeedSlider.value);
      localStorage.setItem('maxSpeed', maxSpeed.toFixed(1));

      consoleEnabled = document.getElementById('enable-console').checked;
      consoleTopicName = document.getElementById('console-topic').value || '/rosout';
      consoleMessageType = document.getElementById('message-type').value || 'rcl_interfaces/msg/Log';
      publishTopicName = document.getElementById('publish-topic').value || '/chatter';

      localStorage.setItem('consoleEnabled', consoleEnabled);
      localStorage.setItem('consoleTopicName', consoleTopicName);
      localStorage.setItem('consoleMessageType', consoleMessageType);
      localStorage.setItem('publishTopicName', publishTopicName);

      connectToRos();
    });

    sendMessageBtn.addEventListener('click', () => {
      const msgText = document.getElementById('publish-message').value;
      if (msgText && publisher) {
        const msg = new ROSLIB.Message({ data: msgText });
        publisher.publish(msg);
        document.getElementById('publish-message').value = '';
      }
    });

    function connectToRos() {
      ros = new ROSLIB.Ros({ url: rosUrl });

      ros.on('connection', () => {
        rosStatus.textContent = 'Connesso';
        rosStatus.className = 'text-success fw-bold';
        setupRosTopics();
      });

      ros.on('error', () => {
        rosStatus.textContent = 'Errore';
        rosStatus.className = 'text-danger fw-bold';
      });

      ros.on('close', () => {
        rosStatus.textContent = 'Non connesso';
        rosStatus.className = 'text-danger fw-bold';
      });
    }

    function setupRosTopics() {
      // Video
      const imageTopic = new ROSLIB.Topic({
        ros: ros,
        name: '/image_raw/compressed',
        messageType: 'sensor_msgs/CompressedImage'
      });

      imageTopic.subscribe((message) => {
        const canvas = document.getElementById('image-canvas');
        const ctx = canvas.getContext('2d');
        const img = new Image();
        img.onload = () => ctx.drawImage(img, 0, 0, canvas.width, canvas.height);
        img.src = 'data:image/jpeg;base64,' + message.data;
      });


      const batteryTopic = new ROSLIB.Topic({
        ros: ros,
        name: '/battery_state_broadcaster/battery_state_throttled',
        messageType: 'sensor_msgs/BatteryState'
      });

      const table = [
            [12.60, 100], [12.40, 90], [12.20, 80], [12.00, 70],
            [11.80, 60], [11.60, 50], [11.40, 40], [11.20, 30],
            [11.00, 20], [10.80, 10], [10.50, 5], [9.60, 0]
        ];

        function voltageToPercent(voltage) {
            // Fuori dai limiti della tabella
            if (voltage >= table[0][0]) return table[0][1];
            if (voltage <= table[table.length - 1][0]) return table[table.length - 1][1];

            // Cerca i due punti tra cui interpolare
            for (let i = 0; i < table.length - 1; i++) {
                const [v1, p1] = table[i];
                const [v2, p2] = table[i + 1];

                if (voltage <= v1 && voltage >= v2) {
                    const ratio = (voltage - v2) / (v1 - v2);
                    return p2 + ratio * (p1 - p2);
                }
            }
        }

      batteryTopic.subscribe((message) => {
        //const percent = Math.round(message.voltage / 11.7 * 100); // valore tra 0.0 e 1.0
        const percent = Math.round(voltageToPercent(message.voltage));
        document.getElementById('battery-text').textContent = `Batteria: ${percent}%`;
      });

      const deadZone = 0.05; // soglia per ignorare piccoli movimenti

      let robotIsIdle = true; // stato del joystick robot

      // === Joystick robot ===
      const joystick = nipplejs.create({
        zone: document.getElementById('joystick-zone'),
        mode: 'static',
        position: { left: '50%', top: '50%' },
        color: 'blue',
        size: 150,
        maxDistance: 150
      });

      // === Buffer per comandi robot ===
      let currentLinear = 0;
      let currentAngular = 0;

      // === Publisher ROS2 per /cmd_vel ===
      const cmdVel = new ROSLIB.Topic({
        ros: ros,
        name: '/cmd_vel',
        messageType: 'geometry_msgs/Twist'
      });

      // === Timer per invio periodico a 10 Hz ===
      setInterval(() => {
        if (!isJoystickControlEnabled()) return; // ‚õî Non inviare comandi se disattivato

        cmdVel.publish(new ROSLIB.Message({
          linear: { x: currentLinear, y: 0, z: 0 },
          angular: { x: 0, y: 0, z: currentAngular }
        }));

        const status = (currentLinear === 0 && currentAngular === 0)
          ? 'üõë Comando di stop inviato'
          : `üì§ Comando inviato: vx=${currentLinear.toFixed(2)}, wz=${currentAngular.toFixed(2)}`;

        //console.log(status);
      }, 100); // 10 Hz

      // === Joystick robot ===
      joystick.on('move', (evt, data) => {
        const nippleEl = document.querySelector('#joystick-zone .nipple');
        if (nippleEl) nippleEl.classList.add('active');

        if (data && data.vector) {
          const rawX = data.vector.x; // va' da -1 a 1
          const rawY = data.vector.y; // va' da -1 a 1

          const linear = maxSpeed * rawY * -1;
          const angular = maxSpeed * rawX;

          const linearFiltered = Math.abs(linear) < deadZone * maxSpeed ? 0 : linear;
          const angularFiltered = Math.abs(angular) < deadZone * maxSpeed ? 0 : angular;

          linearDisplay.textContent = linearFiltered.toFixed(2);
          angularDisplay.textContent = angularFiltered.toFixed(2);

          //console.log(`Joystick robot ‚Üí Linear: ${linearFiltered}, Angular: ${angularFiltered}`);

          // üîÑ Aggiorna buffer per invio periodico
          currentLinear = linearFiltered;
          currentAngular = angularFiltered;
        }
      });

      joystick.on('end', () => {
        const nippleEl = document.querySelector('#joystick-zone .nipple');
        if (nippleEl) nippleEl.classList.remove('active');

        linearDisplay.textContent = '0.00';
        angularDisplay.textContent = '0.00';

        console.log('Joystick robot ‚Üí STOP');

        // üîÑ Imposta buffer a zero per invio continuo di stop
        currentLinear = 0;
        currentAngular = 0;
      });

      // === ROS publisher per la telecamera ===
      const servoTopic = new ROSLIB.Topic({
        ros: ros,
        name: '/servo_position_controller/commands',
        messageType: 'std_msgs/Float64MultiArray'
      });
      
      
      const SERVO_PAN_MIN_DEG = 0.0  // [¬∞]
      const SERVO_PAN_MAX_DEG = 180.0  // [¬∞]
      const SERVO_TILT_MIN_DEG = 0.0  // [¬∞]
      const SERVO_TILT_MAX_DEG = 45.0  // [¬∞]

      let currentPan = 0.5 * (SERVO_PAN_MAX_DEG - SERVO_PAN_MIN_DEG) * (Math.PI / 180);
      let currentTilt = 0;
      


      // === Timer per invio continuo dei comandi telecamera (10 Hz) ===
      setInterval(() => {
        servoTopic.publish(new ROSLIB.Message({ data: [currentPan, currentTilt] }));
      }, 100);

      // === Joystick telecamera ===
      const cameraJoystick = nipplejs.create({
        zone: document.getElementById('camera-joystick-zone'),
        mode: 'static',
        position: { left: '50%', top: '50%' },
        color: 'green',
        size: 150,
        maxDistance: 150
      });

      cameraJoystick.on('move', (evt, data) => {
        const nippleEl = document.querySelector('#camera-joystick-zone .nipple');
        if (nippleEl) nippleEl.classList.add('active');

        if (data && data.vector) {
          const rawX = data.vector.x;
          const rawY = data.vector.y;

          const pan = -rawX;  // va' da -1 a 1
          //const tilt = rawY * -1;
          const tilt = rawY * 1;

          const panFiltered =
              Math.abs(pan) < deadZone
                ? 0
                : (Number(pan.toFixed(2)) + 1) * 0.5 * (SERVO_PAN_MAX_DEG - SERVO_PAN_MIN_DEG) * (Math.PI / 180);

          const tiltFiltered =
              Math.abs(tilt) < deadZone || tilt < 0
                ? 0
                : SERVO_TILT_MIN_DEG* (Math.PI / 180) + (Math.abs(Number(tilt.toFixed(2))) * (SERVO_TILT_MAX_DEG - SERVO_TILT_MIN_DEG)) * (Math.PI / 180);

          
          
          console.log(`Joystick pan/tilt ‚Üí Pan: ${panFiltered } (${Number(pan.toFixed(2))}), Tilt: ${tiltFiltered} (${Number(tilt.toFixed(2))})`);

          // üîÑ Aggiorna buffer per invio continuo
          currentPan = panFiltered;
          currentTilt = tiltFiltered;
        }
      });

      cameraJoystick.on('end', () => {
        const nippleEl = document.querySelector('#camera-joystick-zone .nipple');
        if (nippleEl) nippleEl.classList.remove('active');

        // üîÑ Imposta buffer a zero per invio continuo di stop
        currentPan = 0.5 * (SERVO_PAN_MAX_DEG - SERVO_PAN_MIN_DEG) * (Math.PI / 180);
        currentTilt = 0;
      });



      // Console ROS
      if (consoleSubscriber) {
        consoleSubscriber.unsubscribe();
        consoleSubscriber = null;
      }

      if (consoleEnabled) {
        consoleSection.classList.remove('d-none');
        consoleOutput.textContent = '';

        console.log('üü° Inizializzazione sottoscrizione al topic:', consoleTopicName);
        consoleSubscriber = new ROSLIB.Topic({
          ros: ros,
          name: consoleTopicName, // es: '/rosout'
          messageType: consoleMessageType // es: 'rcl_interfaces/msg/Log'
        });

        consoleSubscriber.subscribe((message) => {
          //console.log('üü¢ Messaggio ricevuto:', message);

          const now = new Date().toLocaleTimeString();
          let line = `[${now}] `;

          if (consoleMessageType === 'std_msgs/String' || consoleMessageType === 'std_msgs/Float64') {
            line += message.data;
          } else if (consoleMessageType === 'geometry_msgs/Twist') {
            line += `linear: ${JSON.stringify(message.linear)}, angular: ${JSON.stringify(message.angular)}`;
          } else if (consoleMessageType === 'rcl_interfaces/msg/Log') {
            let levelLabel = '';
            let color = '';

            switch (message.level) {
              case 10: levelLabel = 'DEBUG'; color = 'gray'; break;
              case 20: levelLabel = 'INFO'; color = 'blue'; break;
              case 30: levelLabel = 'WARN'; color = 'orange'; break;
              case 40: levelLabel = 'ERROR'; color = 'red'; break;
              case 50: levelLabel = 'FATAL'; color = 'darkred'; break;
              default: levelLabel = 'UNKNOWN'; color = 'black';
            }

            line += `[${levelLabel}] ${message.name}: ${message.msg}`;
            consoleOutput.textContent += line + '\n';

            // Stampa colorata in console browser
            //console.log(`%c${line}`, `color: ${color}`);
          } else {
            line += JSON.stringify(message);
            consoleOutput.textContent += line + '\n';
          }

          consoleOutput.scrollTop = consoleOutput.scrollHeight;
        });

        // Verifica connessione WebSocket
        ros.on('connection', () => {
          console.log('‚úÖ Connessione WebSocket stabilita con rosbridge');
        });

        ros.on('error', (error) => {
          console.error('‚ùå Errore nella connessione WebSocket:', error);
        });

        ros.on('close', () => {
          console.warn('‚ö†Ô∏è Connessione WebSocket chiusa');
        });
      } else {
        consoleSection.classList.add('d-none');
        console.log('üî¥ Console disabilitata, sezione nascosta');
      }

      function isJoystickControlEnabled() {
        return document.getElementById('joystickControlToggle').checked;
      }

      document.getElementById('calibrationLink').addEventListener('click', () => {
        // üîß Disattiva invio comandi joystick
        document.getElementById('joystickControlToggle').checked = false;

        // üßπ Se usi variabili come currentLinear/currentAngular, azzera anche quelle
        currentLinear = 0;
        currentAngular = 0;

        console.log('üîí Controllo joystick disattivato per calibrazione');
      });

    }
  </script>
</body>

</html>
