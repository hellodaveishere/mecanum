<!DOCTYPE html>
<html lang="it">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Interfaccia Calibrazione Robot</title>

  <!-- Bootstrap -->
  <link rel="stylesheet" href="css/bootstrap.min.css" />
  <script src="js/bootstrap.bundle.min.js"></script>

  <!-- ROSLIB -->
  <script src="https://cdn.jsdelivr.net/npm/roslib/build/roslib.min.js"></script>
</head>
<body class="bg-light">
  <div class="container py-4">
    <h2 class="mb-4">üõ†Ô∏è Interfaccia Calibrazione Robot</h2>

    <!-- Selettore dispositivo -->
    <div class="mb-3">
      <label for="deviceSelect" class="form-label">Dispositivo da calibrare</label>
      <select class="form-select" id="deviceSelect">
        <option value="mecanum_cmd_node" selected>Mecanum Robot</option>
        <option value="arm_controller">Braccio Robotico</option>
        <option value="drone_controller">Drone</option>
      </select>
    </div>

    <!-- Tipo di test -->
    <div class="mb-3">
      <label for="testType" class="form-label">Tipo di test</label>
      <select class="form-select" id="testType">
        <option value="rettilineo">Rettilineo</option>
        <option value="strafe">Strafe</option>
        <option value="rotazione">Rotazione</option>
      </select>
    </div>

    <!-- Valore errore -->
    <div class="mb-3">
      <label for="errorValue" class="form-label">Valore errore misurato</label>
      <input type="number" step="0.01" class="form-control" id="errorValue" placeholder="Es. 3.2" />
    </div>

    <!-- Pulsante invio -->
    <button class="btn btn-primary" onclick="sendCalibration()">Invia dati di calibrazione</button>

    <!-- Output -->
    <div class="mt-4">
      <h5>üì° Messaggi di calibrazione</h5>
      <pre id="calibOutput" class="bg-white border p-3" style="min-height: 150px;"></pre>
    </div>
  </div>

  <script>
    // Connessione a rosbridge
    const ros = new ROSLIB.Ros({
      url: 'ws://localhost:9090' // Assicurati che rosbridge sia attivo su questa porta
    });

    ros.on('connection', () => {
      console.log('‚úÖ Connesso a rosbridge');
    });

    ros.on('error', (error) => {
      console.error('‚ùå Errore rosbridge:', error);
    });

    // Listener per messaggi di calibrazione
    const calibListener = new ROSLIB.Topic({
      ros: ros,
      name: '/calibration_status',
      messageType: 'std_msgs/String'
    });

    calibListener.subscribe((message) => {
      document.getElementById('calibOutput').innerText = message.data;
    });

    // Funzione per inviare dati al servizio
    function sendCalibration() {
      const device = document.getElementById('deviceSelect').value;
      const testType = document.getElementById('testType').value;
      const errorValue = parseFloat(document.getElementById('errorValue').value);

      if (isNaN(errorValue)) {
        alert('Inserisci un valore di errore valido.');
        return;
      }

      const service = new ROSLIB.Service({
        ros: ros,
        name: `/${device}/run_calibration_test`,
        serviceType: 'custom_interfaces/CalibrationInput'
      });

      const request = new ROSLIB.ServiceRequest({
        test_type: testType,
        error_value: errorValue
      });

      service.callService(request, (result) => {
        document.getElementById('calibOutput').innerText = result.result;
      });
    }
  </script>
</body>
</html>
