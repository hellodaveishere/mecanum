# ============================================================
# ðŸ› ï¸ ROS 2 Dev Container - Raspberry Pi 4 Headless con GUI opzionale
# ============================================================
# ðŸ“ STRUTTURA DEL PROGETTO:
# ros2-dev-container/
# â”œâ”€â”€ docker-compose.yaml
# â”œâ”€â”€ Dockerfile
# â”œâ”€â”€ start_ros2_container.sh
# â”œâ”€â”€ stop_ros2_container.sh
# â””â”€â”€ src/                # Codice sorgente ROS 2 copiato dal laptop

# ðŸ“¦ REQUISITI:
# - Raspberry Pi 4 con Docker e Docker Compose installati
# - ROS 2 Jazzy compatibile con Ubuntu Noble
# - GUI opzionale: attivabile con profilo "gui"

# ðŸš€ AVVIO:
# ./start_ros2_container.sh        # senza GUI
# ./start_ros2_container.sh --gui # con GUI

# ðŸ§¼ STOP:
# ./stop_ros2_container.sh
# ============================================================

version: '3.8'

services:
  ros2-dev:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        USERNAME: dave

    container_name: ros2-dev
    privileged: true
    network_mode: host
    pid: host
    ipc: host

    environment:
      ROS_AUTOMATIC_DISCOVERY_RANGE: LOCALHOST
      ROS_DOMAIN_ID: "42"

    volumes:
      - .:/home/ws
      - /dev:/dev
      - /dev/dri:/dev/dri
      - ${HOME}/.ssh:/home/dave/.ssh

    working_dir: /home/ws
    user: dave

    command: >
      bash -c "
        echo 'source /opt/ros/jazzy/setup.bash' >> ~/.bashrc &&
        sudo rosdep init || true &&
        sudo rosdep update &&
        mkdir -p /home/ws/src &&
        sudo rosdep install --from-paths /home/ws/src --ignore-src -y &&
        exec /bin/bash
      "

    profiles:
      - default

  ros2-dev-gui:
    extends:
      service: ros2-dev
    environment:
      DISPLAY: ${DISPLAY:-":0"}
    volumes:
      - /tmp/.X11-unix:/tmp/.X11-unix
    profiles:
      - gui
